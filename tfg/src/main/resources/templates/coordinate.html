{{> fragments/header}}
<div class="coor-wrapper">
  
  <div class="coor-layout">
    <div class="coor-timer marcador" id="coor-timer">Tiempo: 90</div>
    <div class="coor-juego">
      <h1 class="coor-titulo">¿Cuál es la respuesta correcta?</h1>
      <div id="coor-pregunta" class="coor-pregunta"></div>
      <div class="coor-grid" id="coor-grid"></div>
      <div class="coor-opciones">
        <button class="coor-boton" onclick="verificarRespuesta(this)"></button>
        <button class="coor-boton" onclick="verificarRespuesta(this)"></button>
        <button class="coor-boton" onclick="verificarRespuesta(this)"></button>
        <button class="coor-boton" onclick="verificarRespuesta(this)"></button>
      </div>
      <div id="coor-feedback" class="coor-feedback"></div>
    </div>

    <div id="coor-puntos" class="coor-puntos marcador"></div>
  </div>
</div>

<div id="popup-final" class="coor-popup">
  <div class="coor-popup-content">
    <h2>🎉 Juego Terminado 🎉</h2>
    <p id="popup-puntos">Puntuación Total: 0 puntos</p>
    <div style="margin-top: 1.5rem;">
      <button onclick="reiniciarJuego()" class="popup-boton">Reiniciar</button>
      <button onclick="salirDelJuego()" class="popup-boton">Salir</button>
    </div>
  </div>
</div>


<script src="/js/api.js"></script>
<script>
const size = 5;
let respuestaCorrecta = "";
let score = 0;
let aciertos = 0;
let fallos = 0;
let tiempoRestante = 5;
let temporizador;

function generarJuego() {
  const grid = document.getElementById("coor-grid");
  grid.innerHTML = "";

  const coordenadaAvionX = Math.floor(Math.random() * size);
  const coordenadaAvionY = Math.floor(Math.random() * size);

  let coordenadaTorreX, coordenadaTorreY;
  do {
    coordenadaTorreX = Math.floor(Math.random() * size);
    coordenadaTorreY = Math.floor(Math.random() * size);
  } while (coordenadaTorreX === coordenadaAvionX && coordenadaTorreY === coordenadaAvionY);

  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      const cell = document.createElement("div");
      cell.className = "coor-celda";
      if (x === coordenadaAvionX && y === coordenadaAvionY) {
        cell.textContent = "✈️";
      } else if (x === coordenadaTorreX && y === coordenadaTorreY) {
        cell.textContent = "🏁";
      }
      grid.appendChild(cell);
    }
  }

  const dx = coordenadaTorreX - coordenadaAvionX;
  const dy = coordenadaTorreY - coordenadaAvionY;

  document.getElementById("coor-pregunta").textContent = `¿Qué distancia hay desde el avión hasta la meta?`;
  const distancia = calcularDistanciaMN(dx, dy);
  respuestaCorrecta = distancia.toString();

  const opciones = generarOpcionesDistancia(parseInt(distancia));
  asignarOpciones(opciones);
  actualizarPuntos();
  limpiarFeedback();
}

function calcularDistanciaMN(dx, dy) {
  const pasosHoriz = Math.abs(dx);
  const pasosVert = Math.abs(dy);
  const diagonales = Math.min(pasosHoriz, pasosVert);
  const rectos = Math.abs(pasosHoriz - pasosVert);
  return diagonales * 14 + rectos * 10;
}

function generarOpcionesDistancia(correcta) {
  const opciones = new Set([correcta]);
  while (opciones.size < 4) {
    const variacion = (Math.floor(Math.random() * 7) - 3) * 10;
    const nueva = correcta + variacion;
    if (nueva > 0 && nueva !== correcta) {
      opciones.add(nueva);
    }
  }
  return Array.from(opciones).sort(() => Math.random() - 0.5);
}

function asignarOpciones(opciones) {
  document.querySelectorAll(".coor-boton").forEach((btn, i) => {
    btn.disabled = false;
    btn.textContent = opciones[i];
  });
}

function verificarRespuesta(boton) {
  const feedback = document.getElementById("coor-feedback");

  if (boton.textContent === respuestaCorrecta) {
    score += 10;
    aciertos += 1;
    feedback.textContent = "¡Correcto! +10 puntos 🎉";
    feedback.style.color = "green";
  } else {
    score -= 5;
    fallos += 1;
    feedback.textContent = `¡Incorrecto! -5 puntos ❌ (Respuesta: ${respuestaCorrecta})`;
    feedback.style.color = "red";
  }

  actualizarPuntos();
  document.querySelectorAll(".coor-boton").forEach(b => b.disabled = true);

  setTimeout(generarJuego, 1500);
}

function actualizarPuntos() {
  const puntosDiv = document.getElementById("coor-puntos");
  puntosDiv.textContent = `Puntos: ${score}`;
}

function limpiarFeedback() {
  document.getElementById("coor-feedback").textContent = "";
}

function mostrarMensajeFinal() {
  clearInterval(temporizador);
  document.querySelectorAll(".coor-boton").forEach(b => b.disabled = true);
  const popup = document.getElementById("popup-final");
  const popupTexto = document.getElementById("popup-puntos");

  popupTexto.textContent = `Puntuación Total: ${score} puntos`;
  popup.style.display = "flex";
  console.log(score);
  const username = getCookie("username");

  const payload = {
  username: username,
  score: score,
  aciertos: aciertos,
  fallos: fallos
  };

  const jsonString = JSON.stringify(payload, null, 2);
  console.log(jsonString);

  enviar("/games/coordinate", jsonString, "POST");
}

function actualizarTemporizador() {
  const timer = document.getElementById("coor-timer");
  tiempoRestante--;
  timer.textContent = `Tiempo: ${tiempoRestante}`;

  if (tiempoRestante <= 0) {
    mostrarMensajeFinal();
  }
}

function iniciarJuego() {
  score = 0;
  aciertos = 0;
  fallos = 0;
  tiempoRestante = 5;
  document.getElementById("coor-timer").textContent = `Tiempo: ${tiempoRestante}`;
  generarJuego();
  temporizador = setInterval(actualizarTemporizador, 1000);
}

function reiniciarJuego() {
  const popup = document.getElementById("popup-final");
  popup.style.display = "none";
  iniciarJuego();
}

function salirDelJuego() {
  const popup = document.getElementById("popup-final");
  popup.style.display = "none";
  window.location.href = "/principalJuegos";
}

iniciarJuego();
</script>


{{> fragments/footer}}