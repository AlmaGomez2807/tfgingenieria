{{> fragments/header}}

<div class="mt-wrapper">
  <!-- Juego y marcador en layout flexible -->
  <div class="mt-flex">
    <!-- Juego principal -->
     
    <div class="coor-timer marcador" id="coor-timer">Tiempo: 90</div>
    <div class="mt-container">
      
      <!-- FILA 1: Iconos y pregunta -->
      <div class="mt-figures-row">
        <div class="mt-figure" id="figure1">âœˆï¸</div>
        <div class="mt-question-block">
          <h1 class="mt-title">Â¡Multitask!</h1>

          <!-- Feedback solo para figuras -->
          <div id="figures-feedback" class="mt-feedback"></div>
          <h2 class="mt-section-title">Â¿Las figuras son iguales? </h2>
          <div class="mt-button-group">
            <button class="mt-button" onclick="checkFigures(true)">Â¡Son iguales!</button>
            <button class="mt-button" onclick="checkFigures(false)">No son iguales</button>
          </div>
        </div>
        <div class="mt-figure" id="figure2">ğŸ›©ï¸</div>
      </div>

      <!-- FILA 2: OperaciÃ³n aritmÃ©tica -->
      <div class="mt-section-wide">
        <!-- Feedback solo para ecuaciones -->
        <div id="equation-feedback" class="mt-feedback"></div>

        <h2 class="mt-section-title">Â¿Es correcta la operaciÃ³n?</h2>
        <div id="equation" class="mt-equation">2 + 2 = 4</div>
        <div class="mt-button-group">
          <button class="mt-button" onclick="checkEquation(true)">Â¡Es correcta!</button>
          <button class="mt-button" onclick="checkEquation(false)">No es correcta</button>
        </div>
      </div>

      <!-- FILA 3: Sonido -->
      <div class="mt-section-wide">
        <h2 class="mt-section-title">Â¡Pulsa ESPACIO cuando oigas el sonido!</h2>
        <div id="sound-feedback" class="mt-sound-feedback"></div>
        <!-- NUEVO BOTÃ“N PARA TABLETS -->
        <button class="mt-button" onclick="handleSpacePress()">Pulsa aquÃ­</button>
      </div>
    </div>

    <!-- Marcador -->
    <div class="coor-puntos marcador" id="coor-puntos">Puntos: 0</div>
  </div>
</div>
<div id="popup-final" class="coor-popup">
  <div class="coor-popup-content">
    <h2>ğŸ‰ Juego Terminado ğŸ‰</h2>
    <p id="popup-puntos">PuntuaciÃ³n Total: 0 puntos</p>
    <div style="margin-top: 1.5rem;">
      <button onclick="reiniciarJuego()" class="popup-boton">Reiniciar</button>
      <button onclick="salirDelJuego()" class="popup-boton">Salir</button>
    </div>
  </div>
</div>

<audio id="beep-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
<script src="/js/api.js"></script>
<script>
  const figures = ['âœˆï¸', 'ğŸ›©ï¸', 'ğŸ›«', 'ğŸ›¬', 'ğŸšâ€‹', 'ğŸš€â€‹', 'ğŸ‘©â€âœˆï¸â€‹', 'ğŸ‘¨â€âœˆï¸'];
  const figure1 = document.getElementById('figure1');
  const figure2 = document.getElementById('figure2');
  const equationEl = document.getElementById('equation');
  const soundFeedback = document.getElementById('sound-feedback');
  const beepSound = document.getElementById('beep-sound');
  const figuresFeedback = document.getElementById('figures-feedback');
  const equationFeedback = document.getElementById('equation-feedback');
  const puntosEl = document.getElementById('coor-puntos');
  const timerEl = document.getElementById('coor-timer');
  const popup = document.getElementById("popup-final");
  const popupTexto = document.getElementById("popup-puntos");

  let currentEquationCorrect = true;
  let waitingForSpace = false;
  let figuresAreEqual = false;
  let score = 0;
  let aciertos = 0;
  let fallos = 0;
  
  let aciertoFiguras = 0;
  let falloFiguras = 0;
  let aciertoOperacion = 0;
  let falloOperacion = 0;
  let aciertoEspacio = 0;
  let falloEspacio = 0;

  let tiempoRestante = 90;
  let timerInterval = null;
  let beepInterval = null;
  let juegoTerminado = false;

  function actualizarPuntos(valor) {
    score += valor;
    if (score < 0) score = 0;
    puntosEl.textContent = `Puntos: ${score}`;
  }

  function randomFigure() {
    return figures[Math.floor(Math.random() * figures.length)];
  }

  function generateFigures() {
    const fig1 = randomFigure();
    const isSame = Math.random() < 0.5;
    const fig2 = isSame ? fig1 : randomFigure();
    figuresAreEqual = fig1 === fig2;
    figure1.textContent = fig1;
    figure2.textContent = fig2;
  }

  function generateEquation() {
    const a = Math.floor(Math.random() * 10);
    const b = Math.floor(Math.random() * 10);
    const realResult = a + b;
    const shownResult = Math.random() < 0.5 ? realResult : realResult + (Math.random() < 0.5 ? 1 : -1);
    currentEquationCorrect = realResult === shownResult;
    equationEl.textContent = `${a} + ${b} = ${shownResult}`;
  }

  function checkFigures(playerThinksEqual) {
    if (juegoTerminado) return;
    const isCorrect = playerThinksEqual === figuresAreEqual;
    if(isCorrect){
      aciertoFiguras += 1;
    }else{
      falloFiguras += 1;
    }
    
    figuresFeedback.textContent = isCorrect ? 'âœ… Â¡Correcto! +10 puntos': 'âŒ Incorrecto -5 puntos';
    if (isCorrect){
      aciertos += 1;
    }
    else{
      fallos += 1;
    }
    actualizarPuntos(isCorrect ? 10 : -5);
    setTimeout(() => {
      figuresFeedback.textContent = '';
      generateFigures();
    }, 1200);
  }

  function checkEquation(playerThinksCorrect) {
    if (juegoTerminado) return;
    const isCorrect = playerThinksCorrect === currentEquationCorrect;
    if(isCorrect){
      aciertoOperacion += 1;
      aciertos += 1;
    }else{
      falloOperacion += 1;
      fallos += 1;
    }
    equationFeedback.textContent = isCorrect ? 'âœ… Â¡Correcto! +10 puntos' : 'âŒ Incorrecto -5 puntos';

    actualizarPuntos(isCorrect ? 10 : -5);
    setTimeout(() => {
      equationFeedback.textContent = '';
      generateEquation();
    }, 1200);
  }

  function playBeep() {
    if (tiempoRestante <= 0 || juegoTerminado) return;
    beepSound.play();
    waitingForSpace = true;
    soundFeedback.textContent = 'Â¡Dale a ESPACIO!';
    setTimeout(() => {
      if (waitingForSpace) {
        soundFeedback.textContent = 'â±ï¸ Demasiado tarde... -5 puntos';
        falloEspacio += 1;
        actualizarPuntos(-5);
        waitingForSpace = false;
      }
    }, 2000);
  }

  // NUEVA FUNCIÃ“N COMÃšN PARA ESPACIO (teclado o botÃ³n)
  function handleSpacePress() {
    if (waitingForSpace && !juegoTerminado) {
      soundFeedback.textContent = 'âœ… Â¡Bien hecho! +10 puntos';
      aciertoEspacio += 1;
      aciertos += 1;
      actualizarPuntos(10);
      waitingForSpace = false;
    }
  }

  // Listener de teclado
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
      e.preventDefault();
      handleSpacePress();
    }
  });

  function actualizarTemporizador() {
    if (tiempoRestante > 0) {
      tiempoRestante--;
      timerEl.textContent = `Tiempo: ${tiempoRestante}`;
    }
    if (tiempoRestante <= 0 && !juegoTerminado) {
      terminarJuego();
    }
  }

  function terminarJuego() {
    juegoTerminado = true;
    clearInterval(timerInterval);
    clearInterval(beepInterval);
    popupTexto.textContent = `PuntuaciÃ³n Total: ${score} puntos`;
    popup.style.display = "flex";

    console.log(score);
    const username = getCookie("username");

    const payload = {
      username: username,
      score: score,
      aciertos: aciertos,
      fallos: fallos,
      aciertoFiguras: aciertoFiguras,
      falloFiguras: falloFiguras,
      aciertoOperacion: aciertoOperacion,
      falloOperacion: falloOperacion,
      aciertoEspacio: aciertoEspacio,
      falloEspacio: falloEspacio
    };

    const jsonString = JSON.stringify(payload, null, 2);
    console.log(jsonString);

    enviar("/games/multitask", jsonString, "POST");
  }

  function reiniciarJuego() {
    popup.style.display = "none";
    score = 0;
    tiempoRestante = 90;
    puntosEl.textContent = 'Puntos: 0';
    timerEl.textContent = 'Tiempo: 90s';
    soundFeedback.textContent = '';
    equationFeedback.textContent = '';
    figuresFeedback.textContent = '';
    waitingForSpace = false;
    juegoTerminado = false;
    generateFigures();
    generateEquation();
    timerInterval = setInterval(actualizarTemporizador, 1000);
    beepInterval = setInterval(playBeep, 9000 + Math.random() * 5000);
    score = 0;
    aciertos = 0;
    fallos = 0;
    aciertoEspacio = 0;
    falloEspacio = 0;
    aciertoFiguras = 0;
    falloFiguras = 0;
    aciertoOperacion = 0;
    falloOperacion = 0;
  }

  function salirDelJuego() {
    window.location.href = "/principalJuegos";
  }

  reiniciarJuego();
</script>

{{> fragments/footer}}
