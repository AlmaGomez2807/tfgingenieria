{{> fragments/header}}
<div class="rk-container-fluid">
  

  <div class="row justify-content-between text-center mb-3">
    <div class="col-3 text-start">
      <div class="coor-timer marcador" id="coor-timer">Tiempo: 90</div>
    </div>
    <div class="col-3 text-end">
      <div class="coor-puntos marcador" id="coor-puntos">Puntos: 0</div>
    </div>
  </div>

  <div class="row align-items-start">
    <!-- Controles avi√≥n 1 -->
    <div class="col-md-3 text-center">
      <div class="rk-controls-izq">
        <h2 class="rk-subtitle">Avi√≥n Rojo</h2>
        <div class="control-pad">
          <button class="btn-up" onclick="changeAltitude('plane1', 'up')">‚¨ÜÔ∏è</button>
          <button class="btn-left" onclick="changeDirection('plane1', 'left')">‚¨ÖÔ∏è</button>
          <button class="btn-right" onclick="changeDirection('plane1', 'right')">‚û°Ô∏è</button>
          <button class="btn-down" onclick="changeAltitude('plane1', 'down')">‚¨áÔ∏è</button>
        </div>
      </div>
    </div>

    <!-- Radar en el centro -->
    <div class="col-md-6 justify-content-center coor-juego coor-rc">
      <div class="col-lg-12">
        <h1 class="rk-title">Lleva cada avi√≥n a su correspondiente meta</h1>
        <div id="rk-feedback" class="rk-feedback"></div>
      </div>
      
      <div class="rk-container col-lg-12 mt-4">
        <div class="rk-radar">
          <div class="meta-zone-r" style="left:50px; top:50px; width:60px; height:60px;"></div>
          <div class="meta-zone-a" style="left:180px; top:130px; width:60px; height:60px;"></div>
          <div class="rk-plane" id="plane1"></div>
          <div class="rk-plane rk-plane2" id="plane2"></div>
        </div>
      </div>
    </div>

    <!-- Controles avi√≥n 2 -->
    <div class="col-md-3 text-center">
      <div class="rk-controls-der">
        <h2 class="rk-subtitle">Avi√≥n Azul</h2>
        <div class="control-pad">
          <button class="btn-up" onclick="changeAltitude('plane2', 'up')">‚¨ÜÔ∏è</button>
          <button class="btn-left" onclick="changeDirection('plane2', 'left')">‚¨ÖÔ∏è</button>
          <button class="btn-right" onclick="changeDirection('plane2', 'right')">‚û°Ô∏è</button>
          <button class="btn-down" onclick="changeAltitude('plane2', 'down')">‚¨áÔ∏è</button>
        </div>
      </div>
    </div>

    
  </div>
</div>

<div id="popup-final" class="coor-popup">
  <div class="coor-popup-content">
    <h2>üéâ Juego Terminado üéâ</h2>
    <p id="popup-puntos">Puntuaci√≥n Total: 0 puntos</p>
    <div style="margin-top: 1.5rem;">
      <button onclick="reiniciarJuego()" class="popup-boton">Reiniciar</button>
      <button onclick="salirDelJuego()" class="popup-boton">Salir</button>
    </div>
  </div>
</div>


<script src="/js/api.js"></script>
<script>
  const plane1 = document.getElementById('plane1');
  const plane2 = document.getElementById('plane2');
  const radar = document.querySelector('.rk-radar');
  const timerEl = document.getElementById('coor-timer');
  const pointsEl = document.getElementById('coor-puntos');
  const popup = document.getElementById('popup-final');
  const popupTexto = document.getElementById('popup-puntos');

  const planeSize = 30;

  let x1, y1, dir1;
  let x2, y2, dir2;
  let dx1, dy1;
  let dx2, dy2;

  let radarWidth = 0;
  let radarHeight = 0;

  let score = 0;
  let aciertos = 0;
  let fallos = 0;
  let totalAzul = 0;
  let totalRojo = 0;
  let tiempoRestante = 90;
  let timerInterval = null;
  let juegoTerminado = false;

  // --- NUEVO: zonas meta ---
  // Definimos las zonas meta (ajusta x,y,width,height seg√∫n necesites)
  const metas = [
    { x: 50, y: 50, width: 60, height: 60 },   // Zona meta 1
    { x: 180, y: 130, width: 60, height: 60 }  // Zona meta 2
  ];

  // Flags para controlar si el avi√≥n ya alcanz√≥ la meta y evitar sumar puntos repetidos
  let plane1EnMeta = false;
  let plane2EnMeta = false;

  function getRadarSize() {
    const rect = radar.getBoundingClientRect();
    return {
      width: rect.width,
      height: rect.height
    };
  }

  function getRandomPosition() {
    return {
      x: Math.floor(Math.random() * (radarWidth - planeSize)),
      y: Math.floor(Math.random() * (radarHeight - planeSize))
    };
  }

  // Funci√≥n para comprobar si una posici√≥n (x,y) est√° dentro de una zona meta
  function estaEnMeta(x, y, meta) {
    return x >= meta.x && x <= meta.x + meta.width &&
           y >= meta.y && y <= meta.y + meta.height;
  }

  function moverMeta(metaIndex) {
  // Nueva posici√≥n aleatoria dentro del radar (considerando tama√±o meta)
  metas[metaIndex].x = Math.floor(Math.random() * (radarWidth - metas[metaIndex].width));
  metas[metaIndex].y = Math.floor(Math.random() * (radarHeight - metas[metaIndex].height));

  // Actualizar la posici√≥n visual de la meta en el DOM
  const metaElements = document.querySelectorAll('.meta-zone-r, .meta-zone-a');
  if (metaIndex === 0) {
    metaElements[0].style.left = metas[0].x + 'px';
    metaElements[0].style.top = metas[0].y + 'px';
  } else if (metaIndex === 1) {
    metaElements[1].style.left = metas[1].x + 'px';
    metaElements[1].style.top = metas[1].y + 'px';
  }
}
function checkPlaneMeta(planeId, x, y, metaIndexCorrect, metaIndexWrong, flagName) {
  if (!window[flagName]) {
    if (estaEnMeta(x, y, metas[metaIndexCorrect])) {
      sumarPuntos(10);
      window[flagName] = true;
      moverMeta(metaIndexCorrect);
    } else if (estaEnMeta(x, y, metas[metaIndexWrong])) {
      sumarPuntos(-0);
      window[flagName] = true;
    }
  } else {
    if (!estaEnMeta(x, y, metas[metaIndexCorrect]) && !estaEnMeta(x, y, metas[metaIndexWrong])) {
      window[flagName] = false;
    }
  }
}


function movePlanes() {
  if (!juegoTerminado) {
    // Mover avi√≥n 1
    x1 += dx1;
    y1 += dy1;
    if (x1 > radarWidth - planeSize) x1 = -planeSize;
    if (x1 < -planeSize) x1 = radarWidth - planeSize;
    if (y1 > radarHeight - planeSize) y1 = -planeSize;
    if (y1 < -planeSize) y1 = radarHeight - planeSize;
    plane1.style.left = x1 + 'px';
    plane1.style.top = y1 + 'px';

    // Mover avi√≥n 2
    x2 += dx2;
    y2 += dy2;
    if (x2 > radarWidth - planeSize) x2 = -planeSize;
    if (x2 < -planeSize) x2 = radarWidth - planeSize;
    if (y2 > radarHeight - planeSize) y2 = -planeSize;
    if (y2 < -planeSize) y2 = radarHeight - planeSize;
    plane2.style.left = x2 + 'px';
    plane2.style.top = y2 + 'px';

    // Detectar colisi√≥n
    if (
      x1 < x2 + planeSize &&
      x1 + planeSize > x2 &&
      y1 < y2 + planeSize &&
      y1 + planeSize > y2
    ) {
      terminarJuego();
      return;
    }

    // Avi√≥n rojo solo suma en meta roja (metas[0])
    if (!plane1EnMeta) {
      if (estaEnMeta(x1, y1, metas[0])) {
        sumarPuntos(10);
        plane1EnMeta = true;
        moverMeta(0); // Mover meta roja a nueva posici√≥n
      } else if (estaEnMeta(x1, y1, metas[1])) {
        sumarPuntos(-0);
        plane1EnMeta = true;
      }
    } else {
      if (!estaEnMeta(x1, y1, metas[0]) && !estaEnMeta(x1, y1, metas[1])) {
        plane1EnMeta = false;
      }
    }

    // Avi√≥n azul solo suma en meta azul 
    if (!plane2EnMeta) {
      if (estaEnMeta(x2, y2, metas[1])) {
        sumarPuntos(10);
        plane2EnMeta = true;
        moverMeta(1); // Mover meta azul a nueva posici√≥n
      } else if (estaEnMeta(x2, y2, metas[0])) {
        sumarPuntos(-0);
        plane2EnMeta = true;
      }
    } else {
      if (!estaEnMeta(x2, y2, metas[0]) && !estaEnMeta(x2, y2, metas[1])) {
        plane2EnMeta = false;
      }
    }

    requestAnimationFrame(movePlanes);
  }
}

  function changeDirection(planeId, direction) {
    const speed = 0.2;
    if (planeId === 'plane1') {
      totalRojo += 1;
      console.log(totalRojo)
      dx1 = direction === 'left' ? -speed : speed;
      dy1 = 0;
      plane1.style.transform = direction === 'left' ? 'rotate(180deg)' : 'rotate(0deg)';
    } else if (planeId === 'plane2') {
      totalAzul += 1;
      dx2 = direction === 'left' ? -speed : speed;
      dy2 = 0;
      plane2.style.transform = direction === 'left' ? 'rotate(180deg)' : 'rotate(0deg)';
    }
  }

  function changeAltitude(planeId, direction) {
    const speed = 0.2;
    if (planeId === 'plane1') {
      totalRojo += 1;
      dy1 = direction === 'up' ? -speed : speed;
      dx1 = 0;
      plane1.style.transform = direction === 'up' ? 'rotate(-90deg)' : 'rotate(90deg)';
    } else if (planeId === 'plane2') {
      totalAzul += 1;
      dy2 = direction === 'up' ? -speed : speed;
      dx2 = 0;
      plane2.style.transform = direction === 'up' ? 'rotate(-90deg)' : 'rotate(90deg)';
    }
  }

  function actualizarTemporizador() {
    if (tiempoRestante > 0) {
      tiempoRestante--;
      timerEl.textContent = `Tiempo: ${tiempoRestante}`;
    }
    if (tiempoRestante <= 0 && !juegoTerminado) {
      terminarJuego();
    }
  }

  function resetGame() {
    dx1 = 0.2; dy1 = 0;  // avi√≥n 1 se mueve hacia la derecha inicialmente
    dx2 = 0.2; dy2 = 0;  // avi√≥n 2 igual
    const radarSize = getRadarSize();
    radarWidth = radarSize.width;
    radarHeight = radarSize.height;
    score = 0;
    tiempoRestante = 90;
    const pos1 = getRandomPosition();
    const pos2 = getRandomPosition();
    x1 = pos1.x;
    y1 = pos1.y;
    x2 = pos2.x;
    y2 = pos2.y;
    dir1 = 0.2;
    dir2 = 0.2;
    plane1EnMeta = false; // reset flags al reiniciar
    plane2EnMeta = false;
    timerEl.textContent = 'Tiempo: 90s';
    pointsEl.textContent = 'Puntos: 0';
    plane1.style.left = x1 + 'px';
    plane1.style.top = y1 + 'px';
    plane2.style.left = x2 + 'px';
    plane2.style.top = y2 + 'px';
    juegoTerminado = false;
    popup.style.display = "none";
    score = 0;
    aciertos = 0;
    fallos = 0;
    totalAzul = 0;
    totalRojo = 0;
  }

  function sumarPuntos(valor) {
  score += valor;
  pointsEl.textContent = `Puntos: ${score}`;

  const feedback = document.getElementById("rk-feedback");
  if (valor > 0) {
    feedback.textContent = `‚úÖ ¬°Correcto! +${valor} puntos`;
    aciertos += 1;
    feedback.style.color = "green";
  } else {
    feedback.textContent = `¬°‚ùå ¬°Incorrecto! Vuelve a probar`;
    fallos += 1;
    feedback.style.color = "red";
  }
  clearTimeout(feedback._timeout);
  feedback._timeout = setTimeout(() => {
    feedback.textContent = "";
  }, 2000);
}


  function terminarJuego() {
    juegoTerminado = true;
    clearInterval(timerInterval);
    popupTexto.textContent = `Puntuaci√≥n Total: ${score} puntos`;
    popup.style.display = "flex";

    console.log(score);
    const username = getCookie("username");

    const payload = {
      username: username,
      score: score,
      aciertos: aciertos,
      fallos: fallos,
      totalAzul: totalAzul,
      totalRojo: totalRojo
    };

    const jsonString = JSON.stringify(payload, null, 2);
    console.log(jsonString);

    enviar("/games/rcontrol", jsonString, "POST");
}


  function reiniciarJuego() {
    resetGame();
    timerInterval = setInterval(actualizarTemporizador, 1000);
    movePlanes();
  }
  function salirDelJuego() {
  window.location.href = "/principalJuegos"; 
}

  function iniciarJuego() {
    resetGame();
    timerInterval = setInterval(actualizarTemporizador, 1000);
    movePlanes();
  }

  iniciarJuego();
</script>



{{> fragments/footer}}